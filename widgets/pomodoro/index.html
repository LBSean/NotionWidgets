<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pomodoro Timer</title>
  <link rel="stylesheet" href="../../shared/base.css" />

  <style>
    /* â”€â”€ Mode colour tokens â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    :root {
      --c-accent:  #e55c5c;
      --c-bg:      #fff8f7;
      --c-text:    #2c1810;
      --c-surface: #fff2f0;
      --c-border:  #f0d8d5;
    }
    [data-mode="break"] {
      --c-accent:  #4a9eda;
      --c-bg:      #f0f7ff;
      --c-text:    #0d2137;
      --c-surface: #e8f3fd;
      --c-border:  #c5dff5;
    }
    [data-mode="longBreak"] {
      --c-accent:  #3ab07a;
      --c-bg:      #f0fff7;
      --c-text:    #0d2b1a;
      --c-surface: #e0f9ed;
      --c-border:  #b5e8d0;
    }
    [data-mode="eyeBreak"] {
      --c-accent:  #f59e0b;
      --c-bg:      #fffbf0;
      --c-text:    #2d1f00;
      --c-surface: #fef3c7;
      --c-border:  #fde68a;
    }

    /* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    body {
      background: var(--c-bg);
      color: var(--c-text);
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100%;
      transition: background 0.6s ease, color 0.6s ease;
    }

    .pomo {
      width: 100%;
      max-width: 340px;
      padding: 1.75rem 1.25rem 1.25rem;
      text-align: center;
    }

    /* â”€â”€ Mode label â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .pomo__mode {
      font-size: 0.65rem;
      font-weight: 700;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--c-accent);
      margin-bottom: 0.6rem;
      transition: color 0.6s;
    }

    /* â”€â”€ Time display â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .pomo__time {
      font-size: clamp(3.5rem, 16vw, 5rem);
      font-weight: 200;
      font-family: "SF Mono", "Fira Code", "Courier New", monospace;
      color: var(--c-text);
      letter-spacing: -0.02em;
      line-height: 1;
      transition: color 0.6s;
    }

    /* â”€â”€ Session dots â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .pomo__dots {
      display: flex;
      justify-content: center;
      gap: 6px;
      margin: 1.1rem 0 1.5rem;
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--c-border);
      transition: background 0.3s, transform 0.2s;
    }
    .dot.is-done {
      background: var(--c-accent);
      transform: scale(1.15);
    }

    /* â”€â”€ Controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .pomo__controls {
      display: flex;
      gap: 0.6rem;
      justify-content: center;
    }

    .btn {
      padding: 0.55em 1.4em;
      border-radius: 8px;
      font-size: 0.88rem;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: filter 0.15s, border-color 0.15s, color 0.15s;
    }

    .btn--primary {
      background: var(--c-accent);
      color: #fff;
      min-width: 88px;
      transition: background 0.6s, filter 0.15s;
    }
    .btn--primary:hover { filter: brightness(0.92); }

    .btn--ghost {
      background: transparent;
      color: var(--c-text);
      border: 1.5px solid var(--c-border);
    }
    .btn--ghost:hover {
      border-color: var(--c-accent);
      color: var(--c-accent);
    }

    /* â”€â”€ Footer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .pomo__footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 1.25rem;
      padding: 0 0.1rem;
    }

    .pomo__log {
      font-size: 0.7rem;
      color: #aaa;
      height: 1em;
    }

    .btn-icon {
      background: none;
      border: none;
      cursor: pointer;
      color: #c0b8b5;
      font-size: 1rem;
      padding: 0.2rem 0.3rem;
      border-radius: 4px;
      line-height: 1;
      transition: color 0.15s;
    }
    .btn-icon:hover { color: var(--c-accent); }

    /* â”€â”€ Settings panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .settings {
      position: fixed;
      inset: 0;
      background: #fff;
      overflow-y: auto;
      padding: 1.2rem 1.4rem 2rem;
      transform: translateY(100%);
      transition: transform 0.32s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 10;
    }
    .settings.is-open { transform: translateY(0); }

    .settings__head {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1.4rem;
    }
    .settings__head h2 { font-size: 0.95rem; font-weight: 700; }

    .section-title {
      font-size: 0.65rem;
      font-weight: 700;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: #bbb;
      margin: 1.4rem 0 0.8rem;
    }

    /* â”€â”€ Preset buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .presets {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.4rem;
      margin-bottom: 0.9rem;
    }
    .preset-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.15rem;
      padding: 0.55em 0.4em;
      border: 1.5px solid #e0e0e0;
      border-radius: 8px;
      background: #f9f9f9;
      cursor: pointer;
      font-size: 0.78rem;
      font-weight: 600;
      color: #555;
      transition: border-color 0.15s, background 0.15s, color 0.15s;
    }
    .preset-btn span {
      font-size: 0.68rem;
      font-weight: 400;
      color: #aaa;
    }
    .preset-btn.is-active {
      border-color: #4a9eda;
      background: #e8f4fd;
      color: #1a6ea8;
    }
    .preset-btn.is-active span { color: #4a9eda; }
    .preset-btn:hover:not(.is-active) { border-color: #bbb; background: #f0f0f0; }

    .field {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.65rem;
    }
    .field label {
      flex: 1;
      font-size: 0.82rem;
      font-weight: 500;
      color: #444;
    }
    .field input[type="number"] {
      width: 62px;
      padding: 0.4em 0.5em;
      text-align: center;
      border: 1.5px solid #e0e0e0;
      border-radius: 6px;
      font-size: 0.88rem;
    }
    .field .unit { font-size: 0.75rem; color: #aaa; }

    /* Toggle switch */
    .toggle-wrap {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.65rem;
    }
    .toggle-wrap label {
      flex: 1;
      font-size: 0.82rem;
      font-weight: 500;
      color: #444;
    }
    .toggle {
      position: relative;
      width: 38px;
      height: 22px;
      flex-shrink: 0;
    }
    .toggle input { opacity: 0; width: 0; height: 0; }
    .toggle-track {
      position: absolute;
      inset: 0;
      border-radius: 99px;
      background: #ddd;
      cursor: pointer;
      transition: background 0.2s;
    }
    .toggle-track::after {
      content: '';
      position: absolute;
      left: 3px;
      top: 3px;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #fff;
      transition: transform 0.2s;
    }
    .toggle input:checked + .toggle-track { background: #4a9eda; }
    .toggle input:checked + .toggle-track::after { transform: translateX(16px); }

    .micro-fields {
      padding-left: 0.25rem;
      border-left: 2px solid #f0f0f0;
      margin-bottom: 0.5rem;
    }
    .micro-fields.is-hidden { display: none; }

    .field--col {
      display: flex;
      flex-direction: column;
      align-items: stretch;
      gap: 0.35rem;
      margin-bottom: 0.8rem;
    }
    .field--col label {
      font-size: 0.82rem;
      font-weight: 500;
      color: #444;
    }
    .field--col input[type="url"],
    .field--col input[type="text"] {
      width: 100%;
      padding: 0.45em 0.6em;
      border: 1.5px solid #e0e0e0;
      border-radius: 6px;
      font-size: 0.82rem;
      outline: none;
      transition: border-color 0.15s;
    }
    .field--col input:focus { border-color: #4a9eda; }

    .hint {
      font-size: 0.74rem;
      color: #aaa;
      line-height: 1.5;
      margin-bottom: 0.75rem;
    }

    .webhook-row {
      display: flex;
      gap: 0.4rem;
      align-items: center;
    }
    .webhook-row input { flex: 1; }

    .btn-test {
      flex-shrink: 0;
      padding: 0.42em 0.75em;
      background: #f0f0f0;
      color: #444;
      border: 1.5px solid #e0e0e0;
      border-radius: 6px;
      font-size: 0.78rem;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      transition: background 0.1s;
    }
    .btn-test:hover { background: #e5e5e5; }
    .btn-test:disabled { opacity: 0.5; cursor: not-allowed; }

    .test-result {
      font-size: 0.72rem;
      margin-top: 0.25rem;
      min-height: 1em;
    }
    .test-result.ok  { color: #22c55e; }
    .test-result.err { color: #ef4444; }

    .btn-save {
      width: 100%;
      padding: 0.65em;
      background: #4a9eda;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 0.88rem;
      font-weight: 600;
      cursor: pointer;
      margin-top: 1rem;
    }
    .btn-save:hover { background: #2980b9; }

    /* â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .toast {
      position: fixed;
      bottom: 1rem;
      left: 50%;
      transform: translateX(-50%) translateY(calc(100% + 1.5rem));
      background: #333;
      color: #fff;
      padding: 0.45em 1em;
      border-radius: 6px;
      font-size: 0.78rem;
      white-space: nowrap;
      pointer-events: none;
      transition: transform 0.28s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 99;
    }
    .toast.show { transform: translateX(-50%) translateY(0); }
  </style>
</head>
<body data-mode="work">

  <!-- â”€â”€ Main timer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="pomo">
    <div class="pomo__mode"  id="modeLabel">Work Session</div>
    <div class="pomo__time"  id="display">25:00</div>
    <div class="pomo__dots"  id="dots"></div>

    <div class="pomo__controls">
      <button class="btn btn--primary" id="startBtn">Start</button>
      <button class="btn btn--ghost"   id="resetBtn">Reset</button>
    </div>

    <div class="pomo__footer">
      <span class="pomo__log" id="logStatus"></span>
      <button class="btn-icon" id="settingsBtn" title="Settings">âš™</button>
    </div>
  </div>

  <!-- â”€â”€ Settings panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="settings" id="settingsPanel">
    <div class="settings__head">
      <button class="btn-icon" id="closeSettings">â†</button>
      <h2>Settings</h2>
    </div>

    <p class="section-title">Session Preset</p>
    <div class="presets">
      <button class="preset-btn" data-preset="standard" type="button">
        Standard<span>25 / 5</span>
      </button>
      <button class="preset-btn" data-preset="long" type="button">
        Long Focus<span>50 / 10</span>
      </button>
      <button class="preset-btn" data-preset="custom" type="button">
        Custom<span>your values</span>
      </button>
    </div>

    <p class="section-title">Timer Durations</p>
    <div class="field">
      <label for="sWork">Work</label>
      <input type="number" id="sWork" min="1" max="120" value="25" />
      <span class="unit">min</span>
    </div>
    <div class="field">
      <label for="sShort">Short break</label>
      <input type="number" id="sShort" min="1" max="60" value="5" />
      <span class="unit">min</span>
    </div>
    <div class="field">
      <label for="sLong">Long break</label>
      <input type="number" id="sLong" min="1" max="60" value="15" />
      <span class="unit">min</span>
    </div>
    <div class="field">
      <label for="sSessions">Sessions before long break</label>
      <input type="number" id="sSessions" min="2" max="8" value="4" />
    </div>

    <p class="section-title">Eye-Rest Micro-Breaks</p>
    <div class="toggle-wrap">
      <label for="sMicroEn">Enable micro-breaks</label>
      <label class="toggle">
        <input type="checkbox" id="sMicroEn" />
        <span class="toggle-track"></span>
      </label>
    </div>
    <div class="micro-fields is-hidden" id="microFields">
      <div class="field">
        <label for="sMicroInt">Remind me every</label>
        <input type="number" id="sMicroInt" min="15" max="240" value="60" />
        <span class="unit">min work</span>
      </div>
      <div class="field">
        <label for="sMicroDur">Eye-rest duration</label>
        <input type="number" id="sMicroDur" min="1" max="15" value="5" />
        <span class="unit">min</span>
      </div>
    </div>

    <p class="section-title">Notion Logging</p>
    <p class="hint">
      Deploy the Cloudflare Worker in <code>webhook/</code> and paste its URL here. Each completed work session sends a POST with session data (date, duration, label) which the worker writes to your Notion database.
    </p>
    <div class="field--col">
      <label for="sWebhook">Worker URL</label>
      <div class="webhook-row">
        <input type="url" id="sWebhook" placeholder="https://notion-widgets-webhook.<you>.workers.dev" />
        <button class="btn-test" id="testBtn" type="button">Test</button>
      </div>
      <div class="test-result" id="testResult"></div>
    </div>
    <div class="field--col">
      <label for="sLabel">Session label</label>
      <input type="text" id="sLabel" placeholder="e.g. Deep Work, Study, Codingâ€¦" />
    </div>

    <button class="btn-save" id="saveBtn">Save Settings</button>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // â”€â”€ Defaults & config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const DEFAULTS = {
      work: 25, short: 5, long: 15, sessions: 4,
      microEn: false, microInt: 60, microDur: 5,
      webhook: '', label: '',
    };
    let cfg = { ...DEFAULTS, ...JSON.parse(localStorage.getItem('pomo-cfg') || '{}') };

    const MODES = {
      work:     { label: 'Work Session',  dataMode: 'work',      dur: () => cfg.work     },
      short:    { label: 'Short Break',   dataMode: 'break',     dur: () => cfg.short    },
      long:     { label: 'Long Break',    dataMode: 'longBreak', dur: () => cfg.long     },
      eyeBreak: { label: 'ğŸ‘ Eye Rest',   dataMode: 'eyeBreak',  dur: () => cfg.microDur },
    };

    // â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let mode              = 'work';
    let remaining         = cfg.work * 60;
    let completedSessions = 0;
    let cumulativeWorkMin = 0; // tracks work minutes for micro-break
    let running           = false;
    let tickId            = null;
    let audioCtx          = null;

    // â”€â”€ DOM refs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const displayEl   = document.getElementById('display');
    const modeLabelEl = document.getElementById('modeLabel');
    const dotsEl      = document.getElementById('dots');
    const startBtn    = document.getElementById('startBtn');
    const logStatusEl = document.getElementById('logStatus');

    // â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function render() {
      const m = String(Math.floor(remaining / 60)).padStart(2, '0');
      const s = String(remaining % 60).padStart(2, '0');
      displayEl.textContent      = `${m}:${s}`;
      document.title             = `${m}:${s} â€“ ${MODES[mode].label}`;
      modeLabelEl.textContent    = MODES[mode].label;
      document.body.dataset.mode = MODES[mode].dataMode;
      startBtn.textContent       = running ? 'Pause' : 'Start';

      dotsEl.innerHTML = '';
      for (let i = 0; i < cfg.sessions; i++) {
        const d = document.createElement('span');
        d.className = 'dot' + (i < completedSessions ? ' is-done' : '');
        dotsEl.appendChild(d);
      }
    }

    // â”€â”€ Timer control â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function start() {
      requestNotifPerm();
      running = true;
      tickId  = setInterval(tick, 1000);
      render();
    }

    function pause() {
      running = false;
      clearInterval(tickId);
      render();
    }

    function reset() {
      pause();
      remaining = MODES[mode].dur() * 60;
      render();
    }

    function tick() {
      if (remaining <= 0) {
        clearInterval(tickId);
        running = false;
        onComplete();
        return;
      }
      remaining--;
      render();
    }

    function onComplete() {
      chime();
      notify();

      if (mode === 'work') {
        logSession();
        completedSessions++;
        cumulativeWorkMin += cfg.work;

        const isLongBreak = completedSessions >= cfg.sessions;
        if (isLongBreak) completedSessions = 0;

        // Micro-break overrides short breaks (not long breaks)
        if (cfg.microEn && !isLongBreak && cumulativeWorkMin >= cfg.microInt) {
          cumulativeWorkMin = 0;
          switchMode('eyeBreak');
        } else {
          switchMode(isLongBreak ? 'long' : 'short');
        }
      } else {
        // After any break (including eye rest), go back to work
        switchMode('work');
      }

      setTimeout(start, 600);
    }

    function switchMode(m) {
      mode      = m;
      remaining = MODES[m].dur() * 60;
      render();
    }

    // â”€â”€ Audio â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function getAudio() {
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      return audioCtx;
    }

    function chime() {
      try {
        const ctx = getAudio();
        [523.25, 659.25, 783.99, 1046.50].forEach((freq, i) => {
          const osc  = ctx.createOscillator();
          const gain = ctx.createGain();
          const t    = ctx.currentTime + i * 0.16;
          osc.type = 'sine';
          osc.frequency.value = freq;
          gain.gain.setValueAtTime(0, t);
          gain.gain.linearRampToValueAtTime(0.22, t + 0.02);
          gain.gain.exponentialRampToValueAtTime(0.001, t + 1.2);
          osc.connect(gain);
          gain.connect(ctx.destination);
          osc.start(t);
          osc.stop(t + 1.3);
        });
      } catch (e) { /* audio blocked */ }
    }

    // â”€â”€ Notifications â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function requestNotifPerm() {
      if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
      }
    }

    function notify() {
      if ('Notification' in window && Notification.permission === 'granted') {
        const msgs = {
          work:     'Work session done â€” take a break!',
          short:    'Break over â€” time to focus!',
          long:     'Break over â€” time to focus!',
          eyeBreak: 'Break over â€” time to focus!',
        };
        new Notification('Pomodoro', { body: msgs[mode] || 'Timer done!' });
      }
    }

    // â”€â”€ Notion logging via webhook â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function logSession() {
      if (!cfg.webhook) return;
      logStatusEl.textContent = 'Loggingâ€¦';
      const payload = {
        date:        new Date().toISOString().slice(0, 10),
        completedAt: new Date().toLocaleString(),
        duration:    cfg.work,
        type:        'Work',
        label:       cfg.label || 'Pomodoro',
        session:     completedSessions + 1,
      };
      try {
        const res = await fetch(cfg.webhook, {
          method:  'POST',
          headers: { 'Content-Type': 'application/json' },
          body:    JSON.stringify(payload),
        });
        logStatusEl.textContent = res.ok ? 'âœ“ Logged' : 'âš  Log failed';
      } catch {
        logStatusEl.textContent = 'âš  Log failed';
      }
      setTimeout(() => { logStatusEl.textContent = ''; }, 3500);
    }

    // â”€â”€ Settings form â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const PRESETS = {
      standard: { work: 25, short: 5,  long: 15 },
      long:     { work: 50, short: 10, long: 20 },
    };

    function detectPreset() {
      for (const [key, p] of Object.entries(PRESETS)) {
        if (cfg.work === p.work && cfg.short === p.short && cfg.long === p.long) return key;
      }
      return 'custom';
    }

    function applyPresetButtons(active) {
      document.querySelectorAll('.preset-btn').forEach(btn => {
        btn.classList.toggle('is-active', btn.dataset.preset === active);
      });
    }

    function loadForm() {
      document.getElementById('sWork').value     = cfg.work;
      document.getElementById('sShort').value    = cfg.short;
      document.getElementById('sLong').value     = cfg.long;
      document.getElementById('sSessions').value = cfg.sessions;
      document.getElementById('sMicroEn').checked = cfg.microEn;
      document.getElementById('sMicroInt').value = cfg.microInt;
      document.getElementById('sMicroDur').value = cfg.microDur;
      document.getElementById('sWebhook').value  = cfg.webhook;
      document.getElementById('sLabel').value    = cfg.label;
      document.getElementById('microFields').classList.toggle('is-hidden', !cfg.microEn);
      applyPresetButtons(detectPreset());
    }

    function saveSettings() {
      cfg.work     = Math.max(1,  +document.getElementById('sWork').value     || 25);
      cfg.short    = Math.max(1,  +document.getElementById('sShort').value    || 5);
      cfg.long     = Math.max(1,  +document.getElementById('sLong').value     || 15);
      cfg.sessions = Math.max(2,  +document.getElementById('sSessions').value || 4);
      cfg.microEn  = document.getElementById('sMicroEn').checked;
      cfg.microInt = Math.max(15, +document.getElementById('sMicroInt').value || 60);
      cfg.microDur = Math.max(1,  +document.getElementById('sMicroDur').value || 5);
      cfg.webhook  = document.getElementById('sWebhook').value.trim();
      cfg.label    = document.getElementById('sLabel').value.trim();
      localStorage.setItem('pomo-cfg', JSON.stringify(cfg));
      closeSettings();
      reset();
      toast('Settings saved');
    }

    // Preset button clicks
    document.querySelectorAll('.preset-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const key = btn.dataset.preset;
        if (PRESETS[key]) {
          const p = PRESETS[key];
          document.getElementById('sWork').value  = p.work;
          document.getElementById('sShort').value = p.short;
          document.getElementById('sLong').value  = p.long;
        }
        applyPresetButtons(key);
      });
    });

    // Mark "custom" when any duration field is manually edited
    ['sWork', 'sShort', 'sLong'].forEach(id => {
      document.getElementById(id).addEventListener('input', () => applyPresetButtons('custom'));
    });

    // Toggle micro-break fields visibility
    document.getElementById('sMicroEn').addEventListener('change', function () {
      document.getElementById('microFields').classList.toggle('is-hidden', !this.checked);
    });

    const panel = document.getElementById('settingsPanel');
    document.getElementById('settingsBtn').addEventListener('click', () => { loadForm(); panel.classList.add('is-open'); });
    document.getElementById('closeSettings').addEventListener('click', closeSettings);
    document.getElementById('saveBtn').addEventListener('click', saveSettings);
    function closeSettings() { panel.classList.remove('is-open'); }

    // â”€â”€ Test webhook button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById('testBtn').addEventListener('click', async function () {
      const url = document.getElementById('sWebhook').value.trim();
      const resultEl = document.getElementById('testResult');
      if (!url) { resultEl.className = 'test-result err'; resultEl.textContent = 'âš  Enter a URL first'; return; }

      this.disabled = true;
      resultEl.className = 'test-result';
      resultEl.textContent = 'Sendingâ€¦';

      const sample = {
        date:        new Date().toISOString().slice(0, 10),
        completedAt: new Date().toLocaleString(),
        duration:    parseInt(document.getElementById('sWork').value) || 25,
        type:        'Work',
        label:       document.getElementById('sLabel').value.trim() || 'Test',
        session:     0,
      };

      try {
        const res = await fetch(url, {
          method:  'POST',
          headers: { 'Content-Type': 'application/json' },
          body:    JSON.stringify(sample),
        });
        const json = await res.json().catch(() => ({}));
        if (res.ok) {
          resultEl.className   = 'test-result ok';
          resultEl.textContent = `âœ“ Success${json.page_id ? ' â€” page created in Notion' : ''}`;
        } else {
          resultEl.className   = 'test-result err';
          resultEl.textContent = `âœ— ${json.message || json.error || `HTTP ${res.status}`}`;
        }
      } catch (err) {
        resultEl.className   = 'test-result err';
        resultEl.textContent = `âœ— ${err.message}`;
      }

      this.disabled = false;
    });

    // â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const toastEl = document.getElementById('toast');
    let toastTimer;
    function toast(msg) {
      toastEl.textContent = msg;
      toastEl.classList.add('show');
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => toastEl.classList.remove('show'), 2500);
    }

    // â”€â”€ Button wiring â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    startBtn.addEventListener('click', () => { running ? pause() : start(); });
    document.getElementById('resetBtn').addEventListener('click', reset);

    // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    render();
  </script>
</body>
</html>
