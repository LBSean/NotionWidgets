<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>News</title>
  <link rel="stylesheet" href="../../shared/base.css" />
  <script src="../../shared/theme.js"></script>
  <style>
    body {
      display: flex;
      flex-direction: column;
      padding: 1.1rem 1.4rem 0.75rem;
      min-height: 100%;
      position: relative;
      overflow: hidden;
    }

    /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .header {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      margin-bottom: 0.75rem;
      flex-shrink: 0;
    }
    .feed-title {
      font-size: var(--font-size-xs);
      font-weight: 700;
      color: var(--color-text-muted);
      letter-spacing: 0.08em;
      text-transform: uppercase;
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .icon-btn {
      background: none;
      border: none;
      cursor: pointer;
      color: var(--color-text-muted);
      font-size: 0.9rem;
      padding: 2px 4px;
      border-radius: var(--radius-sm);
      line-height: 1;
      transition: color 0.15s;
      flex-shrink: 0;
    }
    .icon-btn:hover { color: var(--color-text); }

    /* â”€â”€ Article list â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .article-list {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .article {
      padding: 0.5rem 0;
      border-bottom: 1px solid var(--color-border);
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
    }
    .article:last-child { border-bottom: none; }

    .article-title {
      font-size: var(--font-size-sm);
      color: var(--color-text);
      font-weight: 500;
      line-height: 1.35;
      text-decoration: none;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .article-title:hover { color: var(--color-accent); }

    .article-meta {
      font-size: var(--font-size-xs);
      color: var(--color-text-muted);
    }

    /* â”€â”€ Source nav â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .source-nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding-top: 0.6rem;
      flex-shrink: 0;
    }
    .nav-btn {
      background: none;
      border: 1px solid var(--color-border);
      cursor: pointer;
      color: var(--color-text-muted);
      font-size: var(--font-size-xs);
      padding: 0.25rem 0.6rem;
      border-radius: var(--radius-sm);
      transition: all 0.15s;
    }
    .nav-btn:hover:not(:disabled) {
      color: var(--color-text);
      border-color: var(--color-text-muted);
    }
    .nav-btn:disabled { opacity: 0.3; cursor: default; }
    .source-dots {
      display: flex;
      gap: 0.35rem;
      align-items: center;
    }
    .dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--color-border);
      transition: background 0.15s;
    }
    .dot.active { background: var(--color-accent); }

    /* â”€â”€ Status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .status {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--color-text-muted);
      font-size: var(--font-size-sm);
      text-align: center;
      padding: 1rem;
    }

    /* â”€â”€ Settings panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .settings-panel {
      position: absolute;
      inset: 0;
      padding: 1.1rem 1.4rem 0.9rem;
      display: flex;
      flex-direction: column;
      gap: 0.7rem;
      transform: translateY(100%);
      transition: transform 0.25s ease;
      z-index: 10;
      background: var(--color-bg, #fff);
      overflow-y: auto;
    }
    @media (prefers-color-scheme: dark) {
      .settings-panel { background: #191a1f; }
    }
    .settings-panel.open { transform: translateY(0); }

    .settings-title {
      font-size: var(--font-size-sm);
      font-weight: 600;
      color: var(--color-text);
      flex-shrink: 0;
    }
    .field-label {
      font-size: var(--font-size-xs);
      color: var(--color-text-muted);
      margin-bottom: 0.25rem;
    }
    .feed-input {
      width: 100%;
      padding: 0.35rem 0.6rem;
      border: 1px solid var(--color-border);
      border-radius: var(--radius-sm);
      background: var(--color-surface);
      color: var(--color-text);
      font-size: var(--font-size-xs);
      font-family: inherit;
      outline: none;
      box-sizing: border-box;
    }
    .feed-input:focus { border-color: var(--color-accent); }

    .slider-row {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    .slider-row input[type=range] {
      flex: 1;
      accent-color: var(--color-accent);
    }
    .slider-val {
      font-size: var(--font-size-xs);
      font-weight: 600;
      color: var(--color-text);
      min-width: 1rem;
      text-align: center;
    }
    .settings-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: auto;
      padding-top: 0.5rem;
      flex-shrink: 0;
    }
    .btn-save {
      padding: 0.35rem 0.9rem;
      background: var(--color-accent);
      color: #fff;
      border: none;
      border-radius: var(--radius-sm);
      font-size: var(--font-size-xs);
      font-weight: 600;
      cursor: pointer;
    }
    .btn-save:hover { opacity: 0.85; }
    .close-btn {
      background: none;
      border: none;
      cursor: pointer;
      color: var(--color-text-muted);
      font-size: var(--font-size-xs);
      padding: 0.3rem 0;
    }
    .close-btn:hover { color: var(--color-text); }

    html[data-theme="dark"]  .settings-panel { background: #191a1f; }
    html[data-theme="light"] .settings-panel { background: #fff; }

    .save-status {
      font-size: var(--font-size-xs);
      color: var(--color-text-muted);
      min-height: 1em;
    }
  </style>
</head>
<body>

  <button class="theme-switch" onclick="__toggleTheme()" title="Toggle light/dark" aria-label="Toggle theme">
    <span class="theme-switch__icon">â˜€</span>
    <span class="theme-switch__track"><span class="theme-switch__thumb"></span></span>
    <span class="theme-switch__icon">ğŸŒ™</span>
  </button>

  <!-- Main view -->
  <div class="header">
    <span class="feed-title" id="feedTitle">News</span>
    <button class="icon-btn" id="refreshBtn" title="Refresh">â†º</button>
    <button class="icon-btn" id="gearBtn" title="Settings">âš™</button>
  </div>

  <div id="statusEl" class="status">Loadingâ€¦</div>

  <div id="mainContent" style="display:none; flex:1; flex-direction:column;">
    <div class="article-list" id="articleList"></div>
    <div class="source-nav">
      <button class="nav-btn" id="prevBtn">â† Prev</button>
      <div class="source-dots" id="sourceDots"></div>
      <button class="nav-btn" id="nextBtn">Next â†’</button>
    </div>
  </div>

  <!-- Settings panel -->
  <div class="settings-panel" id="settingsPanel">
    <span class="settings-title">Feeds</span>

    <div>
      <div class="field-label">Feed 1</div>
      <input class="feed-input" id="feed0" type="url" autocomplete="off"
        placeholder="https://feeds.bbci.co.uk/news/rss.xml" />
    </div>
    <div>
      <div class="field-label">Feed 2</div>
      <input class="feed-input" id="feed1" type="url" autocomplete="off"
        placeholder="https://feeds.apnews.com/rss/apf-topnews" />
    </div>
    <div>
      <div class="field-label">Feed 3</div>
      <input class="feed-input" id="feed2" type="url" autocomplete="off"
        placeholder="https://www.theguardian.com/world/rss" />
    </div>

    <div>
      <div class="field-label">Articles per source</div>
      <div class="slider-row">
        <input type="range" id="perPageSlider" min="3" max="10" step="1" value="5" />
        <span class="slider-val" id="perPageVal">5</span>
      </div>
    </div>

    <div class="settings-actions">
      <span class="save-status" id="saveStatus"></span>
      <div style="display:flex;gap:0.75rem;align-items:center;">
        <button class="close-btn" id="closeBtn">Cancel</button>
        <button class="btn-save" id="saveBtn">Save &amp; Load</button>
      </div>
    </div>
  </div>

  <script>
    // â”€â”€ Defaults â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const STORAGE_KEY = 'news-cfg';
    const CACHE_TTL   = 15 * 60 * 1000; // 15 minutes
    const DEFAULT_FEEDS = [
      'https://feeds.bbci.co.uk/news/rss.xml',
      'https://feeds.apnews.com/rss/apf-topnews',
      'https://www.theguardian.com/world/rss',
    ];

    let cfg = { feeds: [...DEFAULT_FEEDS], perPage: 5 };
    let feedData   = [];
    let currentFeed = 0;

    function loadCfg() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) cfg = { ...cfg, ...JSON.parse(raw) };
        while (cfg.feeds.length < 3) cfg.feeds.push('');
      } catch {}
    }
    function saveCfg() { localStorage.setItem(STORAGE_KEY, JSON.stringify(cfg)); }

    // â”€â”€ Per-feed localStorage cache â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function cacheKey(url) {
      return 'nf_' + url.replace(/[^a-z0-9]/gi, '_').slice(-48);
    }
    function getCached(url) {
      try {
        const raw = localStorage.getItem(cacheKey(url));
        if (!raw) return null;
        const { ts, data } = JSON.parse(raw);
        return { data, stale: Date.now() - ts > CACHE_TTL };
      } catch { return null; }
    }
    function setCache(url, data) {
      try { localStorage.setItem(cacheKey(url), JSON.stringify({ ts: Date.now(), data })); } catch {}
    }

    // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function timeAgo(dateStr) {
      if (!dateStr) return '';
      const diff = Date.now() - new Date(dateStr).getTime();
      const m = Math.floor(diff / 60000);
      if (m < 2)  return 'just now';
      if (m < 60) return `${m}m ago`;
      const h = Math.floor(m / 60);
      if (h < 24) return `${h}h ago`;
      return `${Math.floor(h / 24)}d ago`;
    }
    function escHtml(s) {
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;')
        .replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }
    function stripTags(s) { return String(s).replace(/<[^>]+>/g, '').trim(); }

    // â”€â”€ Fetch via rss2json.com (primary â€” returns clean JSON) â”€â”€â”€â”€â”€
    async function fetchViaRss2Json(url, signal) {
      const api = `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(url)}&count=20`;
      const res  = await fetch(api, { signal });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const json = await res.json();
      if (json.status !== 'ok') throw new Error(json.message || 'Feed error');
      const name = stripTags(json.feed?.title || '') || new URL(url).hostname;
      const articles = (json.items || []).slice(0, 20).map(item => ({
        title:   stripTags(item.title || '') || '(No title)',
        link:    item.link  || '',
        pubDate: item.pubDate || '',
      }));
      if (!articles.length) throw new Error('No items');
      return { name, articles };
    }

    // â”€â”€ Fetch via allorigins proxy (fallback) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function fetchViaProxy(url, signal) {
      const res  = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`, { signal });
      const json = await res.json();
      if (!json.contents) throw new Error('Empty proxy response');
      const doc    = new DOMParser().parseFromString(json.contents, 'text/xml');
      const isAtom = !!doc.querySelector('feed');
      const items  = [...doc.querySelectorAll(isAtom ? 'entry' : 'item')];
      if (!items.length) throw new Error('No items');
      const name = doc.querySelector('channel > title, feed > title')?.textContent?.trim()
                || new URL(url).hostname;
      const articles = items.slice(0, 20).map(item => {
        const title = item.querySelector('title')?.textContent?.trim() || '(No title)';
        const link  = isAtom
          ? (item.querySelector('link[rel="alternate"]')?.getAttribute('href')
          || item.querySelector('link')?.getAttribute('href') || '')
          : (item.querySelector('link')?.textContent?.trim() || '');
        const pubDate = item.querySelector('pubDate, published, updated')?.textContent?.trim() || '';
        return { title, link, pubDate };
      });
      return { name, articles };
    }

    // â”€â”€ Fetch one feed (rss2json â†’ fallback proxy, 8 s timeout) â”€â”€
    async function fetchFeed(url) {
      const ctrl    = new AbortController();
      const timerId = setTimeout(() => ctrl.abort(), 8000);
      try {
        try {
          const r = await fetchViaRss2Json(url, ctrl.signal);
          clearTimeout(timerId);
          return r;
        } catch (e) {
          if (e.name === 'AbortError') throw e;
          const r = await fetchViaProxy(url, ctrl.signal);
          clearTimeout(timerId);
          return r;
        }
      } finally {
        clearTimeout(timerId);
      }
    }

    // â”€â”€ Load all feeds (stale-while-revalidate) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadAllFeeds(force = false) {
      const urls = cfg.feeds.filter(u => u.trim());
      if (!urls.length) { showStatus('Add feed URLs in settings âš™'); openSettings(); return; }

      const cached  = urls.map(url => force ? null : getCached(url));
      const anyCached = cached.some(c => c !== null);
      const allFresh  = anyCached && cached.every(c => c && !c.stale);

      // Serve cache immediately if we have anything
      if (anyCached && !force) {
        feedData = cached.map((c, i) =>
          c ? c.data : { name: new URL(urls[i]).hostname, articles: [] }
        );
        currentFeed = feedData.findIndex(f => f.articles.length > 0);
        if (currentFeed >= 0) { renderFeed(); showMain(); }
        else showStatus('Loadingâ€¦');

        if (allFresh) return; // Everything fresh â€” skip background refresh

        // Background-refresh stale/missing feeds
        setRefreshing(true);
        await Promise.allSettled(
          urls.map((url, i) => {
            if (cached[i] && !cached[i].stale) return Promise.resolve();
            return fetchFeed(url)
              .then(data => { setCache(url, data); feedData[i] = data; })
              .catch(() => {});
          })
        );
        setRefreshing(false);
        const cf = feedData.findIndex(f => f.articles.length > 0);
        if (cf >= 0) { currentFeed = cf; renderFeed(); showMain(); }
        return;
      }

      // No cache or forced refresh
      showStatus('Loading feedsâ€¦');
      const results = await Promise.allSettled(
        urls.map(url => fetchFeed(url).then(data => { setCache(url, data); return data; }))
      );
      feedData = results.map((r, i) =>
        r.status === 'fulfilled' ? r.value : { name: new URL(urls[i]).hostname, articles: [], failed: true }
      );
      if (!feedData.some(f => f.articles.length > 0)) {
        showStatus('Could not load any feeds. Check settings âš™'); return;
      }
      currentFeed = feedData.findIndex(f => f.articles.length > 0);
      renderFeed(); showMain();
    }

    function setRefreshing(on) {
      const btn = document.getElementById('refreshBtn');
      btn.style.opacity  = on ? '0.45' : '1';
      btn.title = on ? 'Refreshing in backgroundâ€¦' : 'Refresh';
    }

    // â”€â”€ Render current feed â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderFeed() {
      const data = feedData[currentFeed];
      document.getElementById('feedTitle').textContent = data.name;

      const list = document.getElementById('articleList');
      list.innerHTML = '';

      const slice = data.articles.slice(0, cfg.perPage);
      if (!slice.length) {
        list.innerHTML = '<div style="padding:0.5rem 0;color:var(--color-text-muted);font-size:var(--font-size-xs)">Could not load this source.</div>';
      } else {
        slice.forEach(a => {
          const el = document.createElement('div');
          el.className = 'article';
          el.innerHTML = `
            <a class="article-title" href="${escHtml(a.link || '#')}" target="_blank" rel="noopener">
              ${escHtml(a.title)}
            </a>
            <div class="article-meta">${a.pubDate ? timeAgo(a.pubDate) : ''}</div>
          `;
          list.appendChild(el);
        });
      }

      const dots = document.getElementById('sourceDots');
      dots.innerHTML = '';
      feedData.forEach((_, i) => {
        const d = document.createElement('span');
        d.className = 'dot' + (i === currentFeed ? ' active' : '');
        dots.appendChild(d);
      });

      document.getElementById('prevBtn').disabled = currentFeed === 0;
      document.getElementById('nextBtn').disabled = currentFeed === feedData.length - 1;
    }

    function showStatus(msg) {
      document.getElementById('statusEl').textContent = msg;
      document.getElementById('statusEl').style.display = 'flex';
      document.getElementById('mainContent').style.display = 'none';
    }
    function showMain() {
      document.getElementById('statusEl').style.display = 'none';
      document.getElementById('mainContent').style.display = 'flex';
    }

    // â”€â”€ Navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById('prevBtn').addEventListener('click', () => {
      if (currentFeed > 0) { currentFeed--; renderFeed(); }
    });
    document.getElementById('nextBtn').addEventListener('click', () => {
      if (currentFeed < feedData.length - 1) { currentFeed++; renderFeed(); }
    });

    // â”€â”€ Settings panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const panel = document.getElementById('settingsPanel');
    const openSettings = () => {
      cfg.feeds.forEach((url, i) => {
        const el = document.getElementById(`feed${i}`);
        if (el) el.value = url;
      });
      document.getElementById('perPageSlider').value = cfg.perPage;
      document.getElementById('perPageVal').textContent = cfg.perPage;
      document.getElementById('saveStatus').textContent = '';
      panel.classList.add('open');
    };
    const closeSettings = () => panel.classList.remove('open');

    document.getElementById('gearBtn').addEventListener('click', openSettings);
    document.getElementById('closeBtn').addEventListener('click', closeSettings);
    document.getElementById('refreshBtn').addEventListener('click', () => loadAllFeeds(true));

    document.getElementById('perPageSlider').addEventListener('input', function() {
      document.getElementById('perPageVal').textContent = this.value;
    });

    document.getElementById('saveBtn').addEventListener('click', async () => {
      cfg.feeds  = [0,1,2].map(i => (document.getElementById(`feed${i}`)?.value.trim() || ''));
      cfg.perPage = parseInt(document.getElementById('perPageSlider').value, 10);
      saveCfg();
      closeSettings();
      feedData = []; currentFeed = 0;
      await loadAllFeeds(true);
    });

    // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    loadCfg();
    loadAllFeeds();
  </script>
</body>
</html>
