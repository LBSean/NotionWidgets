<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>News</title>
  <link rel="stylesheet" href="../../shared/base.css" />
  <style>
    body {
      display: flex;
      flex-direction: column;
      padding: 1.1rem 1.4rem 0.75rem;
      min-height: 100%;
      position: relative;
      overflow: hidden;
    }

    /* ── Header ─────────────────────────────────── */
    .header {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      margin-bottom: 0.75rem;
      flex-shrink: 0;
    }
    .feed-title {
      font-size: var(--font-size-xs);
      font-weight: 700;
      color: var(--color-text-muted);
      letter-spacing: 0.08em;
      text-transform: uppercase;
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .icon-btn {
      background: none;
      border: none;
      cursor: pointer;
      color: var(--color-text-muted);
      font-size: 0.9rem;
      padding: 2px 4px;
      border-radius: var(--radius-sm);
      line-height: 1;
      transition: color 0.15s;
      flex-shrink: 0;
    }
    .icon-btn:hover { color: var(--color-text); }

    /* ── Article list ───────────────────────────── */
    .article-list {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 0;
      overflow: hidden;
    }
    .article {
      padding: 0.5rem 0;
      border-bottom: 1px solid var(--color-border);
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
    }
    .article:last-child { border-bottom: none; }

    .article-title {
      font-size: var(--font-size-sm);
      color: var(--color-text);
      font-weight: 500;
      line-height: 1.35;
      text-decoration: none;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .article-title:hover { color: var(--color-accent); }

    .article-meta {
      font-size: var(--font-size-xs);
      color: var(--color-text-muted);
    }
    .article-meta span + span::before { content: ' · '; }

    /* ── Pagination ─────────────────────────────── */
    .pagination {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding-top: 0.6rem;
      flex-shrink: 0;
    }
    .page-btn {
      background: none;
      border: 1px solid var(--color-border);
      cursor: pointer;
      color: var(--color-text-muted);
      font-size: var(--font-size-xs);
      padding: 0.25rem 0.6rem;
      border-radius: var(--radius-sm);
      transition: all 0.15s;
    }
    .page-btn:hover:not(:disabled) {
      color: var(--color-text);
      border-color: var(--color-text-muted);
    }
    .page-btn:disabled { opacity: 0.3; cursor: default; }
    .page-info {
      font-size: var(--font-size-xs);
      color: var(--color-text-muted);
    }

    /* ── Status ─────────────────────────────────── */
    .status {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--color-text-muted);
      font-size: var(--font-size-sm);
      text-align: center;
      padding: 1rem;
    }

    /* ── Settings panel ─────────────────────────── */
    .settings-panel {
      position: absolute;
      inset: 0;
      padding: 1.1rem 1.4rem 0.9rem;
      display: flex;
      flex-direction: column;
      gap: 0.85rem;
      transform: translateY(100%);
      transition: transform 0.25s ease;
      z-index: 10;
      background: var(--color-bg, #fff);
    }
    @media (prefers-color-scheme: dark) {
      .settings-panel { background: #191a1f; }
    }
    .settings-panel.open { transform: translateY(0); }

    .settings-title {
      font-size: var(--font-size-sm);
      font-weight: 600;
      color: var(--color-text);
    }
    .field-label {
      font-size: var(--font-size-xs);
      color: var(--color-text-muted);
      margin-bottom: 0.3rem;
    }
    .field-hint {
      font-size: var(--font-size-xs);
      color: var(--color-text-muted);
      opacity: 0.7;
      margin-top: 0.25rem;
    }
    .input-row {
      display: flex;
      gap: 0.5rem;
    }
    .input-row input {
      flex: 1;
      padding: 0.35rem 0.6rem;
      border: 1px solid var(--color-border);
      border-radius: var(--radius-sm);
      background: var(--color-surface);
      color: var(--color-text);
      font-size: var(--font-size-xs);
      font-family: inherit;
      outline: none;
      min-width: 0;
    }
    .input-row input:focus { border-color: var(--color-accent); }
    .btn-small {
      padding: 0.35rem 0.75rem;
      background: var(--color-accent);
      color: #fff;
      border: none;
      border-radius: var(--radius-sm);
      font-size: var(--font-size-xs);
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      flex-shrink: 0;
    }
    .btn-small:hover { opacity: 0.85; }

    .slider-row {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    .slider-row input[type=range] {
      flex: 1;
      accent-color: var(--color-accent);
    }
    .slider-val {
      font-size: var(--font-size-xs);
      font-weight: 600;
      color: var(--color-text);
      min-width: 1rem;
      text-align: center;
    }
    .load-error {
      font-size: var(--font-size-xs);
      color: #e05c5c;
    }
    .close-btn {
      align-self: flex-end;
      margin-top: auto;
      background: none;
      border: none;
      cursor: pointer;
      color: var(--color-text-muted);
      font-size: var(--font-size-xs);
      padding: 0.3rem 0;
    }
    .close-btn:hover { color: var(--color-text); }
  </style>
</head>
<body>

  <!-- Main view -->
  <div class="header">
    <span class="feed-title" id="feedTitle">News</span>
    <button class="icon-btn" id="refreshBtn" title="Refresh">↺</button>
    <button class="icon-btn" id="gearBtn" title="Settings">⚙</button>
  </div>

  <div id="statusEl" class="status">Loading…</div>

  <div id="mainContent" style="display:none; flex:1; display:none; flex-direction:column;">
    <div class="article-list" id="articleList"></div>
    <div class="pagination">
      <button class="page-btn" id="prevBtn">← Prev</button>
      <span class="page-info" id="pageInfo"></span>
      <button class="page-btn" id="nextBtn">Next →</button>
    </div>
  </div>

  <!-- Settings panel -->
  <div class="settings-panel" id="settingsPanel">
    <span class="settings-title">Settings</span>

    <div>
      <div class="field-label">RSS feed URL</div>
      <div class="input-row">
        <input type="url" id="feedInput" placeholder="https://feeds.bbci.co.uk/news/rss.xml" autocomplete="off" />
        <button class="btn-small" id="loadBtn">Load</button>
      </div>
      <div class="field-hint">Any RSS or Atom feed URL</div>
      <div class="load-error" id="loadError"></div>
    </div>

    <div>
      <div class="field-label">Articles per page</div>
      <div class="slider-row">
        <input type="range" id="perPageSlider" min="3" max="10" step="1" value="5" />
        <span class="slider-val" id="perPageVal">5</span>
      </div>
    </div>

    <button class="close-btn" id="closeBtn">Done ✕</button>
  </div>

  <script>
    // ── State ────────────────────────────────────────────────────
    const STORAGE_KEY = 'news-cfg';
    let cfg = { feedUrl: '', feedName: '', perPage: 5 };
    let allArticles = [];
    let page = 0;

    function loadCfg() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) cfg = { ...cfg, ...JSON.parse(raw) };
      } catch {}
    }
    function saveCfg() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(cfg));
    }

    // ── Time formatting ──────────────────────────────────────────
    function timeAgo(dateStr) {
      if (!dateStr) return '';
      const diff = Date.now() - new Date(dateStr).getTime();
      const m = Math.floor(diff / 60000);
      if (m < 2)   return 'just now';
      if (m < 60)  return `${m}m ago`;
      const h = Math.floor(m / 60);
      if (h < 24)  return `${h}h ago`;
      const d = Math.floor(h / 24);
      return `${d}d ago`;
    }

    // ── Fetch & parse RSS ────────────────────────────────────────
    async function fetchFeed(url) {
      const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
      const res  = await fetch(proxyUrl);
      const json = await res.json();
      if (!json.contents) throw new Error('Empty response from proxy');

      const parser = new DOMParser();
      const doc    = parser.parseFromString(json.contents, 'text/xml');

      // Support both RSS <item> and Atom <entry>
      const isAtom = doc.querySelector('feed') !== null;
      const items  = isAtom
        ? [...doc.querySelectorAll('entry')]
        : [...doc.querySelectorAll('item')];

      if (!items.length) throw new Error('No articles found in feed');

      // Feed title
      const feedTitleEl = doc.querySelector('channel > title, feed > title');
      const feedName = feedTitleEl?.textContent?.trim() || new URL(url).hostname;

      const articles = items.map(item => {
        const title = item.querySelector('title')?.textContent?.trim() || '(No title)';

        let link = '';
        if (isAtom) {
          link = item.querySelector('link[rel="alternate"]')?.getAttribute('href')
              || item.querySelector('link')?.getAttribute('href')
              || item.querySelector('link')?.textContent?.trim()
              || '';
        } else {
          link = item.querySelector('link')?.textContent?.trim()
              || item.querySelector('link')?.nextSibling?.textContent?.trim()
              || '';
        }

        const pubDate = item.querySelector('pubDate, published, updated')?.textContent?.trim() || '';
        const source  = item.querySelector('source')?.textContent?.trim() || '';

        return { title, link, pubDate, source };
      });

      return { feedName, articles };
    }

    // ── Render ───────────────────────────────────────────────────
    function renderPage() {
      const list  = document.getElementById('articleList');
      const start = page * cfg.perPage;
      const slice = allArticles.slice(start, start + cfg.perPage);
      const total = Math.ceil(allArticles.length / cfg.perPage);

      list.innerHTML = '';
      slice.forEach(a => {
        const el = document.createElement('div');
        el.className = 'article';
        el.innerHTML = `
          <a class="article-title" href="${a.link || '#'}" target="_blank" rel="noopener">
            ${escHtml(a.title)}
          </a>
          <div class="article-meta">
            ${a.source ? `<span>${escHtml(a.source)}</span>` : ''}
            ${a.pubDate ? `<span>${timeAgo(a.pubDate)}</span>` : ''}
          </div>
        `;
        list.appendChild(el);
      });

      document.getElementById('pageInfo').textContent = `${page + 1} / ${total}`;
      document.getElementById('prevBtn').disabled = page === 0;
      document.getElementById('nextBtn').disabled = page >= total - 1;
    }

    function escHtml(s) {
      return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    function showStatus(msg) {
      document.getElementById('statusEl').textContent = msg;
      document.getElementById('statusEl').style.display = 'flex';
      document.getElementById('mainContent').style.display = 'none';
    }
    function showMain() {
      document.getElementById('statusEl').style.display = 'none';
      document.getElementById('mainContent').style.display = 'flex';
    }

    // ── Load feed ────────────────────────────────────────────────
    async function loadFeed(url, fromSettings = false) {
      if (!url) return;
      showStatus('Loading…');
      document.getElementById('loadError').textContent = '';

      try {
        const { feedName, articles } = await fetchFeed(url);
        cfg.feedUrl  = url;
        cfg.feedName = feedName;
        saveCfg();

        allArticles = articles;
        page = 0;
        document.getElementById('feedTitle').textContent = feedName;
        renderPage();
        showMain();
        if (fromSettings) closeSettings();
      } catch (err) {
        if (fromSettings) {
          document.getElementById('loadError').textContent = `Error: ${err.message}`;
          showStatus(cfg.feedUrl ? 'Could not reload feed.' : 'Set a feed URL in settings ⚙');
        } else {
          showStatus('Could not load feed. Check settings ⚙');
        }
      }
    }

    // ── Pagination ───────────────────────────────────────────────
    document.getElementById('prevBtn').addEventListener('click', () => {
      if (page > 0) { page--; renderPage(); }
    });
    document.getElementById('nextBtn').addEventListener('click', () => {
      const total = Math.ceil(allArticles.length / cfg.perPage);
      if (page < total - 1) { page++; renderPage(); }
    });

    // ── Settings panel ───────────────────────────────────────────
    const panel = document.getElementById('settingsPanel');
    const openSettings  = () => panel.classList.add('open');
    const closeSettings = () => panel.classList.remove('open');

    document.getElementById('gearBtn').addEventListener('click', openSettings);
    document.getElementById('closeBtn').addEventListener('click', closeSettings);
    document.getElementById('refreshBtn').addEventListener('click', () => loadFeed(cfg.feedUrl));

    document.getElementById('loadBtn').addEventListener('click', () => {
      const url = document.getElementById('feedInput').value.trim();
      if (url) loadFeed(url, true);
    });
    document.getElementById('feedInput').addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        const url = document.getElementById('feedInput').value.trim();
        if (url) loadFeed(url, true);
      }
    });

    // Per-page slider
    const slider   = document.getElementById('perPageSlider');
    const perPageV = document.getElementById('perPageVal');
    slider.addEventListener('input', () => {
      cfg.perPage = parseInt(slider.value, 10);
      perPageV.textContent = cfg.perPage;
      saveCfg();
      if (allArticles.length) { page = 0; renderPage(); }
    });

    // ── Init ─────────────────────────────────────────────────────
    loadCfg();
    slider.value        = cfg.perPage;
    perPageV.textContent = cfg.perPage;
    if (cfg.feedUrl) {
      document.getElementById('feedInput').value = cfg.feedUrl;
      document.getElementById('feedTitle').textContent = cfg.feedName || 'News';
      loadFeed(cfg.feedUrl);
    } else {
      showStatus('Set a feed URL in settings ⚙');
      openSettings();
    }
  </script>
</body>
</html>
