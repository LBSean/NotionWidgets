<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Habit Tracker</title>
  <link rel="stylesheet" href="../../shared/base.css" />
  <script src="../../shared/theme.js"></script>

  <style>
    /* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    body {
      color: var(--color-text);
      display: flex;
      flex-direction: column;
      min-height: 100%;
      padding: 0.6rem 0.8rem 0.5rem;
      gap: 0.35rem;
      user-select: none;
      position: relative;
      overflow: hidden;
    }

    /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .hm-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 0.3rem;
    }
    .hm-title {
      font-size: var(--font-size-sm);
      font-weight: 600;
      letter-spacing: 0.02em;
    }
    .hm-controls {
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }
    .hm-nav {
      display: flex;
      align-items: center;
      gap: 0.15rem;
    }
    .hm-nav button {
      background: none;
      border: none;
      cursor: pointer;
      color: var(--color-text-muted);
      font-size: 0.9rem;
      padding: 0 4px;
      line-height: 1;
      border-radius: 3px;
    }
    .hm-nav button:hover { color: var(--color-text); }
    .hm-nav-label {
      font-size: 0.7rem;
      font-weight: 500;
      min-width: 2.5em;
      text-align: center;
    }
    .hm-views {
      display: flex;
      gap: 1px;
    }
    .hm-views button {
      background: none;
      border: 1px solid var(--color-border);
      cursor: pointer;
      color: var(--color-text-muted);
      font-size: 0.6rem;
      padding: 2px 8px;
      line-height: 1.2;
    }
    .hm-views button:first-child { border-radius: 4px 0 0 4px; }
    .hm-views button:last-child { border-radius: 0 4px 4px 0; }
    .hm-views button.active {
      background: var(--color-accent);
      color: #fff;
      border-color: var(--color-accent);
    }

    /* â”€â”€ Stats bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .hm-stats {
      display: flex;
      gap: 0.8rem;
      font-size: 0.62rem;
      color: var(--color-text-muted);
    }
    .hm-stat-val {
      font-weight: 700;
      color: var(--color-text);
    }

    /* â”€â”€ Year view â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .hm-year-scroll {
      overflow-x: auto;
      overflow-y: hidden;
      -webkit-overflow-scrolling: touch;
    }
    .hm-year {
      display: flex;
      gap: 0;
    }
    .hm-day-labels {
      display: flex;
      flex-direction: column;
      gap: 1px;
      padding-top: 16px;
      margin-right: 4px;
      flex-shrink: 0;
    }
    .hm-day-label {
      font-size: 0.48rem;
      color: var(--color-text-muted);
      height: 11px;
      line-height: 11px;
      width: 20px;
      text-align: right;
      padding-right: 3px;
    }
    .hm-year-cols {
      display: flex;
      gap: 2px;
    }
    .hm-week-col {
      display: flex;
      flex-direction: column;
      gap: 1px;
    }
    .hm-month-label {
      font-size: 0.48rem;
      color: var(--color-text-muted);
      height: 14px;
      line-height: 14px;
      text-align: left;
      cursor: pointer;
      white-space: nowrap;
    }
    .hm-month-label:hover { color: var(--color-text); }
    .hm-month-label:empty { cursor: default; }

    /* â”€â”€ Cells (shared) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .cell {
      width: 11px;
      height: 11px;
      border-radius: 2px;
      cursor: pointer;
      transition: transform 0.08s;
    }
    .cell:hover { transform: scale(1.4); z-index: 2; }
    .cell.empty { visibility: hidden; cursor: default; }
    .cell.today { outline: 2px solid var(--color-accent); outline-offset: -1px; }
    .cell.future { opacity: 0.35; }

    /* Intensity levels â€” light */
    .lv0 { background: #ebedf0; }
    .lv1 { background: #9be9a8; }
    .lv2 { background: #40c463; }
    .lv3 { background: #30a14e; }
    .lv4 { background: #216e39; }
    /* Intensity levels â€” dark */
    html[data-theme="dark"] .lv0 { background: #21262d; }
    html[data-theme="dark"] .lv1 { background: #0e4429; }
    html[data-theme="dark"] .lv2 { background: #006d32; }
    html[data-theme="dark"] .lv3 { background: #26a641; }
    html[data-theme="dark"] .lv4 { background: #39d353; }
    @media (prefers-color-scheme: dark) {
      :root:not([data-theme]) .lv0 { background: #21262d; }
      :root:not([data-theme]) .lv1 { background: #0e4429; }
      :root:not([data-theme]) .lv2 { background: #006d32; }
      :root:not([data-theme]) .lv3 { background: #26a641; }
      :root:not([data-theme]) .lv4 { background: #39d353; }
    }

    /* â”€â”€ Month view â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .hm-month-view { padding: 0.2rem 0; }
    .hm-month-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 3px;
    }
    .hm-month-day-header {
      font-size: 0.5rem;
      color: var(--color-text-muted);
      text-align: center;
      padding-bottom: 2px;
    }
    .month-cell {
      aspect-ratio: 1;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.58rem;
      color: var(--color-text-muted);
      cursor: pointer;
      transition: transform 0.08s;
      position: relative;
    }
    .month-cell:hover { transform: scale(1.08); z-index: 2; }
    .month-cell.empty { visibility: hidden; cursor: default; }
    .month-cell.today { outline: 2px solid var(--color-accent); outline-offset: -1px; }
    .month-cell.future { opacity: 0.35; }
    .day-num { position: relative; z-index: 1; font-weight: 500; }
    .month-cell.lv1 .day-num,
    .month-cell.lv2 .day-num,
    .month-cell.lv3 .day-num,
    .month-cell.lv4 .day-num { color: #fff; }

    /* â”€â”€ Week view â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .hm-week-view { display: flex; flex-direction: column; gap: 0; }
    .week-row {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.35rem 0;
      border-bottom: 1px solid var(--color-border);
      cursor: pointer;
    }
    .week-row:hover { background: var(--color-surface); }
    .week-row.today-row { background: var(--color-surface); }
    .week-day-name {
      font-size: 0.68rem;
      font-weight: 600;
      width: 28px;
      flex-shrink: 0;
      color: var(--color-text-muted);
    }
    .week-date {
      font-size: 0.58rem;
      color: var(--color-text-muted);
      width: 42px;
      flex-shrink: 0;
    }
    .week-bar {
      flex: 1;
      height: 7px;
      background: var(--color-border);
      border-radius: 4px;
      overflow: hidden;
    }
    .week-bar-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.15s;
    }
    .week-chips {
      display: flex;
      gap: 3px;
      flex-wrap: wrap;
    }
    .week-chip {
      font-size: 0.5rem;
      padding: 1px 5px;
      border-radius: 3px;
      border: 1px solid var(--color-border);
    }
    .week-chip.done { color: #fff; }

    /* â”€â”€ Filter chips â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .hm-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      padding: 0.25rem 0;
    }
    .filter-chip {
      display: flex;
      align-items: center;
      gap: 3px;
      font-size: 0.55rem;
      padding: 2px 7px;
      border-radius: 10px;
      border: 1px solid var(--color-border);
      cursor: pointer;
      background: none;
      color: var(--color-text-muted);
      transition: all 0.12s;
    }
    .filter-chip.active { color: #fff; }
    .filter-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    /* â”€â”€ Legend â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .hm-legend {
      display: flex;
      align-items: center;
      gap: 3px;
      font-size: 0.5rem;
      color: var(--color-text-muted);
    }
    .legend-cell {
      width: 10px;
      height: 10px;
      border-radius: 2px;
    }

    /* â”€â”€ Tooltip â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .hm-tooltip {
      position: fixed;
      z-index: 30;
      background: #24292f;
      color: #e6edf3;
      font-size: 0.58rem;
      padding: 5px 8px;
      border-radius: 5px;
      pointer-events: none;
      white-space: nowrap;
      opacity: 0;
      transition: opacity 0.08s;
      line-height: 1.4;
    }
    .hm-tooltip.visible { opacity: 1; }
    html[data-theme="light"] .hm-tooltip { background: #24292f; color: #e6edf3; }

    /* â”€â”€ Log dialog (native <dialog>) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    dialog {
      border: none;
      border-radius: 10px;
      padding: 0;
      background: #fff;
      box-shadow: 0 8px 32px rgba(0,0,0,0.18);
      max-width: 280px;
      width: calc(100% - 2rem);
    }
    dialog::backdrop { background: rgba(0,0,0,0.25); }
    html[data-theme="dark"] dialog { background: #2a2b33; color: var(--color-text); }
    @media (prefers-color-scheme: dark) {
      :root:not([data-theme]) dialog { background: #2a2b33; color: #e8e8e6; }
    }
    .dlg-inner {
      padding: 0.9rem 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.45rem;
    }
    .dlg-date {
      font-size: 0.78rem;
      font-weight: 600;
    }
    .dlg-row {
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }
    .dlg-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .dlg-name {
      font-size: 0.68rem;
      flex: 1;
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .dlg-slider {
      width: 72px;
      height: 4px;
      cursor: pointer;
    }
    .dlg-pct {
      font-size: 0.6rem;
      width: 28px;
      text-align: right;
      color: var(--color-text-muted);
      font-variant-numeric: tabular-nums;
    }
    .dlg-done {
      margin-top: 0.25rem;
      padding: 0.32rem;
      border: none;
      border-radius: 6px;
      background: var(--color-accent);
      color: #fff;
      font-size: 0.68rem;
      cursor: pointer;
      font-weight: 500;
    }
    .dlg-done:hover { opacity: 0.85; }

    /* â”€â”€ Settings panel (slide-up, matches weather/news) â”€â”€ */
    .settings {
      position: absolute;
      inset: 0;
      background: #fff;
      transform: translateY(100%);
      transition: transform 0.25s ease;
      z-index: 10;
      overflow-y: auto;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.7rem;
    }
    .settings.open { transform: translateY(0); }
    html[data-theme="dark"] .settings { background: #191a1f; }
    html[data-theme="light"] .settings { background: #fff; }
    @media (prefers-color-scheme: dark) {
      :root:not([data-theme]) .settings { background: #191a1f; }
    }
    .settings h2 {
      font-size: 0.85rem;
      font-weight: 600;
    }
    .cat-list {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }
    .cat-row {
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }
    .cat-row input[type="text"] {
      flex: 1;
      font-size: 0.7rem;
      padding: 4px 8px;
      border: 1px solid var(--color-border);
      border-radius: 4px;
      background: transparent;
      color: var(--color-text);
    }
    .cat-row input[type="color"] {
      width: 26px;
      height: 26px;
      border: none;
      cursor: pointer;
      border-radius: 4px;
      padding: 0;
    }
    .cat-del {
      background: none;
      border: none;
      cursor: pointer;
      color: #e74c3c;
      font-size: 0.8rem;
      padding: 2px 4px;
      line-height: 1;
    }
    .cat-del:hover { opacity: 0.6; }
    .settings-btn {
      padding: 0.35rem 0.75rem;
      border: none;
      border-radius: 6px;
      font-size: 0.68rem;
      cursor: pointer;
      font-weight: 500;
    }
    .settings-btn.primary { background: var(--color-accent); color: #fff; }
    .settings-btn.primary:hover { opacity: 0.85; }
    .settings-btn.secondary { background: var(--color-border); color: var(--color-text); }
    .settings-btn.secondary:hover { opacity: 0.75; }
    .settings-actions {
      display: flex;
      gap: 0.4rem;
      margin-top: 0.3rem;
    }

    /* â”€â”€ Bottom bar (filters + legend row) â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .hm-bottom {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 0.3rem;
    }
  </style>
</head>
<body>

  <!-- Widget control bar -->
  <div class="widget-bar">
    <button id="gearBtn" title="Settings" aria-label="Settings">âš™</button>
    <button class="theme-switch" onclick="__toggleTheme()" title="Toggle theme" aria-label="Toggle theme">
      <span class="theme-switch__icon">â˜€</span>
      <span class="theme-switch__track"><span class="theme-switch__thumb"></span></span>
      <span class="theme-switch__icon">ðŸŒ™</span>
    </button>
  </div>

  <!-- Main content (rendered by JS) -->
  <div id="root"></div>

  <!-- Settings panel (slides up from bottom) -->
  <div class="settings" id="settingsPanel">
    <h2>Categories</h2>
    <div class="cat-list" id="catList"></div>
    <button class="settings-btn secondary" id="addCatBtn">+ Add Category</button>
    <div class="settings-actions">
      <button class="settings-btn primary" id="saveSettingsBtn">Save</button>
      <button class="settings-btn secondary" id="cancelSettingsBtn">Cancel</button>
    </div>
  </div>

  <!-- Log dialog (native <dialog> â€” no CSS display hacks needed) -->
  <dialog id="logDialog">
    <div class="dlg-inner">
      <div class="dlg-date" id="dlgDate"></div>
      <div id="dlgHabits"></div>
      <button class="dlg-done" id="dlgDone">Done</button>
    </div>
  </dialog>

  <!-- Hover tooltip -->
  <div class="hm-tooltip" id="tooltip"></div>

  <script>
  (function () {
    'use strict';

    // â”€â”€â”€ Constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const MONTHS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    const MONTH_FULL = ['January','February','March','April','May','June',
                        'July','August','September','October','November','December'];
    const DAYS = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
    const DEFAULT_CATS = [
      { id: 'c_health', name: 'Health',       color: '#39d353' },
      { id: 'c_prod',   name: 'Productivity', color: '#3b82f6' },
      { id: 'c_learn',  name: 'Learning',     color: '#f59e0b' },
      { id: 'c_social', name: 'Social',       color: '#ec4899' }
    ];

    // â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let cfg, viewMode = 'year', viewYear = new Date().getFullYear();
    let viewMonth = new Date().getMonth(), viewWeekStart = null;
    let activeFilters = new Set();

    // â”€â”€â”€ DOM refs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const root          = document.getElementById('root');
    const settingsPanel = document.getElementById('settingsPanel');
    const logDialog     = document.getElementById('logDialog');
    const tooltip       = document.getElementById('tooltip');

    // â”€â”€â”€ Data layer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const uid = () => 'c_' + Math.random().toString(36).slice(2, 9);

    function loadCfg() {
      try { const r = localStorage.getItem('habits-cfg'); if (r) return JSON.parse(r); } catch {}
      return { categories: DEFAULT_CATS.map(c => ({ ...c })) };
    }
    function saveCfg(c) { localStorage.setItem('habits-cfg', JSON.stringify(c)); }

    function loadData(year) {
      try { const r = localStorage.getItem('habits-' + year); if (r) return JSON.parse(r); } catch {}
      return {};
    }
    function saveData(year, d) { localStorage.setItem('habits-' + year, JSON.stringify(d)); }

    function migrateOldData() {
      for (let y = 2020; y <= 2035; y++) {
        const raw = localStorage.getItem('heatmap-' + y);
        if (!raw) continue;
        try {
          const old = JSON.parse(raw), catId = cfg.categories[0]?.id;
          if (!catId) continue;
          const cur = loadData(y);
          for (const [k, v] of Object.entries(old)) {
            if (v && !cur[k]) cur[k] = { [catId]: 100 };
          }
          saveData(y, cur);
          localStorage.removeItem('heatmap-' + y);
        } catch {}
      }
    }

    // â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function iso(d) {
      return d.getFullYear() + '-' +
        String(d.getMonth() + 1).padStart(2, '0') + '-' +
        String(d.getDate()).padStart(2, '0');
    }
    function parseDate(s) { return new Date(s + 'T12:00:00'); }
    function isToday(d) {
      const n = new Date();
      return d.getFullYear() === n.getFullYear() && d.getMonth() === n.getMonth() && d.getDate() === n.getDate();
    }
    function isFuture(d) {
      const n = new Date(); n.setHours(0,0,0,0);
      const dd = new Date(d); dd.setHours(0,0,0,0);
      return dd > n;
    }
    function getMondayOfWeek(d) {
      const dt = new Date(d), dow = dt.getDay();
      dt.setDate(dt.getDate() - ((dow + 6) % 7));
      return dt;
    }

    function getIntensity(dayData) {
      if (!dayData || typeof dayData !== 'object') return 0;
      const vals = cfg.categories
        .filter(c => activeFilters.has(c.id) && dayData[c.id] > 0)
        .map(c => dayData[c.id]);
      if (!vals.length) return 0;
      const avg = vals.reduce((a, b) => a + b, 0) / vals.length;
      if (avg <= 25) return 1;
      if (avg <= 50) return 2;
      if (avg <= 75) return 3;
      return 4;
    }

    function buildWeeks(year) {
      const jan1 = new Date(year, 0, 1);
      const dec31 = new Date(year, 11, 31);
      const start = getMondayOfWeek(jan1);
      const weeks = [];
      let cur = new Date(start);
      while (cur <= dec31 || weeks.length < 52) {
        const wk = [];
        for (let i = 0; i < 7; i++) { wk.push(new Date(cur)); cur.setDate(cur.getDate() + 1); }
        weeks.push(wk);
        if (cur > dec31 && weeks.length >= 52) break;
        if (weeks.length >= 54) break;
      }
      return weeks;
    }

    // â”€â”€â”€ Stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function countActive(data) {
      let n = 0;
      for (const d of Object.values(data))
        if (d && typeof d === 'object' && Object.values(d).some(p => p > 0)) n++;
      return n;
    }
    function calcStreak(data) {
      let s = 0, d = new Date();
      while (true) {
        const day = data[iso(d)];
        if (day && typeof day === 'object' && Object.values(day).some(p => p > 0)) {
          s++; d.setDate(d.getDate() - 1);
        } else break;
      }
      return s;
    }
    function monthPct(data, year, month) {
      const dim = new Date(year, month + 1, 0).getDate();
      let a = 0;
      for (let i = 1; i <= dim; i++) {
        const k = `${year}-${String(month+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
        const d = data[k];
        if (d && typeof d === 'object' && Object.values(d).some(p => p > 0)) a++;
      }
      return Math.round(a / dim * 100);
    }

    // â”€â”€â”€ Rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function render() {
      if (viewMode === 'year') renderYear();
      else if (viewMode === 'month') renderMonth();
      else renderWeek();
    }

    function headerHTML() {
      let nav = '';
      if (viewMode === 'year') {
        nav = `<button data-act="py">â€¹</button><span class="hm-nav-label">${viewYear}</span><button data-act="ny">â€º</button>`;
      } else if (viewMode === 'month') {
        nav = `<button data-act="pm">â€¹</button><span class="hm-nav-label">${MONTH_FULL[viewMonth]} ${viewYear}</span><button data-act="nm">â€º</button>`;
      } else {
        const ws = viewWeekStart, we = new Date(ws); we.setDate(we.getDate() + 6);
        nav = `<button data-act="pw">â€¹</button><span class="hm-nav-label">${MONTHS[ws.getMonth()]} ${ws.getDate()} â€“ ${MONTHS[we.getMonth()]} ${we.getDate()}</span><button data-act="nw">â€º</button>`;
      }
      return `<div class="hm-header">
        <div class="hm-title">${viewYear} Activity</div>
        <div class="hm-controls">
          <div class="hm-nav">${nav}</div>
          <div class="hm-views">
            <button data-view="year" class="${viewMode==='year'?'active':''}">Y</button>
            <button data-view="month" class="${viewMode==='month'?'active':''}">M</button>
            <button data-view="week" class="${viewMode==='week'?'active':''}">W</button>
          </div>
        </div>
      </div>`;
    }

    function statsHTML() {
      const data = loadData(viewYear);
      return `<div class="hm-stats">
        <span><span class="hm-stat-val">${countActive(data)}</span> active</span>
        <span><span class="hm-stat-val">${calcStreak(data)}</span> streak</span>
        <span><span class="hm-stat-val">${monthPct(data, viewYear, new Date().getMonth())}%</span> this month</span>
      </div>`;
    }

    function bottomHTML() {
      const chips = cfg.categories.map(c => {
        const on = activeFilters.has(c.id);
        return `<button class="filter-chip${on?' active':''}" data-cat="${c.id}"
          style="${on?'background:'+c.color+';border-color:'+c.color:''}">
          <span class="filter-dot" style="background:${on?'#fff':c.color}"></span>${c.name}</button>`;
      }).join('');
      return `<div class="hm-bottom">
        <div class="hm-filters">${chips}</div>
        <div class="hm-legend"><span>Less</span>
          <span class="legend-cell lv0"></span><span class="legend-cell lv1"></span>
          <span class="legend-cell lv2"></span><span class="legend-cell lv3"></span>
          <span class="legend-cell lv4"></span><span>More</span>
        </div>
      </div>`;
    }

    function renderYear() {
      const data = loadData(viewYear), weeks = buildWeeks(viewYear);
      // Month labels â€” placed at the first week whose Thursday falls in a new month
      const mLabels = []; let curM = -1;
      weeks.forEach((wk, wi) => {
        const m = wk[3].getMonth();
        if (m !== curM) { mLabels.push({ m, wi }); curM = m; }
      });

      let grid = '<div class="hm-day-labels">';
      for (let i = 0; i < 7; i++)
        grid += `<div class="hm-day-label">${i % 2 === 0 ? DAYS[i] : ''}</div>`;
      grid += '</div><div class="hm-year-cols">';

      weeks.forEach((wk, wi) => {
        let col = '<div class="hm-week-col">';
        const lbl = mLabels.find(l => l.wi === wi);
        col += lbl
          ? `<div class="hm-month-label" data-month="${lbl.m}">${MONTHS[lbl.m]}</div>`
          : '<div class="hm-month-label"></div>';
        wk.forEach(d => {
          if (d.getFullYear() !== viewYear) { col += '<div class="cell empty"></div>'; return; }
          const k = iso(d), lv = getIntensity(data[k]);
          const cls = ['cell', 'lv' + lv];
          if (isToday(d)) cls.push('today');
          if (isFuture(d)) cls.push('future');
          col += `<div class="${cls.join(' ')}" data-date="${k}" tabindex="0"></div>`;
        });
        col += '</div>';
        grid += col;
      });
      grid += '</div>';

      root.innerHTML = headerHTML() + statsHTML() +
        `<div class="hm-year-scroll"><div class="hm-year">${grid}</div></div>` + bottomHTML();
    }

    function renderMonth() {
      const data = loadData(viewYear);
      const dim = new Date(viewYear, viewMonth + 1, 0).getDate();
      const firstDow = (new Date(viewYear, viewMonth, 1).getDay() + 6) % 7;
      let g = DAYS.map(d => `<div class="hm-month-day-header">${d}</div>`).join('');
      for (let i = 0; i < firstDow; i++) g += '<div class="month-cell empty"></div>';
      for (let d = 1; d <= dim; d++) {
        const k = `${viewYear}-${String(viewMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const dt = new Date(viewYear, viewMonth, d);
        const lv = getIntensity(data[k]);
        const cls = ['month-cell', 'lv' + lv];
        if (isToday(dt)) cls.push('today');
        if (isFuture(dt)) cls.push('future');
        g += `<div class="${cls.join(' ')}" data-date="${k}"><span class="day-num">${d}</span></div>`;
      }
      root.innerHTML = headerHTML() + statsHTML() +
        `<div class="hm-month-view"><div class="hm-month-grid">${g}</div></div>` + bottomHTML();
    }

    function renderWeek() {
      if (!viewWeekStart) viewWeekStart = getMondayOfWeek(new Date());
      const yr = viewWeekStart.getFullYear();
      const data = loadData(yr);
      let rows = '';
      for (let i = 0; i < 7; i++) {
        const d = new Date(viewWeekStart); d.setDate(d.getDate() + i);
        const k = iso(d), dd = data[k] || {};
        const cats = cfg.categories.filter(c => activeFilters.has(c.id));
        let avg = 0;
        if (cats.length) avg = Math.round(cats.reduce((s, c) => s + (dd[c.id] || 0), 0) / cats.length);
        const chips = cats.map(c => {
          const p = dd[c.id] || 0;
          return `<span class="week-chip${p>0?' done':''}" style="${p>0?'background:'+c.color+';border-color:'+c.color:''}">${c.name} ${p}%</span>`;
        }).join('');
        const todayCls = isToday(d) ? ' today-row' : '';
        rows += `<div class="week-row${todayCls}" data-date="${k}">
          <span class="week-day-name">${DAYS[i]}</span>
          <span class="week-date">${MONTHS[d.getMonth()]} ${d.getDate()}</span>
          <div class="week-bar"><div class="week-bar-fill" style="width:${avg}%;background:${avg?'#40c463':'transparent'}"></div></div>
          <div class="week-chips">${chips}</div>
        </div>`;
      }
      root.innerHTML = headerHTML() + statsHTML() +
        `<div class="hm-week-view">${rows}</div>` + bottomHTML();
    }

    // â”€â”€â”€ Log dialog â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function openLog(dateKey) {
      const dt = parseDate(dateKey);
      document.getElementById('dlgDate').textContent =
        `${MONTH_FULL[dt.getMonth()]} ${dt.getDate()}, ${dt.getFullYear()}`;
      const yr = dt.getFullYear(), data = loadData(yr), dd = data[dateKey] || {};
      const box = document.getElementById('dlgHabits');
      box.innerHTML = '';

      cfg.categories.forEach(cat => {
        const pct = dd[cat.id] || 0;
        const row = document.createElement('div');
        row.className = 'dlg-row';
        row.innerHTML =
          `<span class="dlg-dot" style="background:${cat.color}"></span>` +
          `<span class="dlg-name">${cat.name}</span>` +
          `<input class="dlg-slider" type="range" min="0" max="100" step="10" value="${pct}" style="accent-color:${cat.color}">` +
          `<span class="dlg-pct">${pct}%</span>`;
        box.appendChild(row);

        const slider = row.querySelector('input');
        const label  = row.querySelector('.dlg-pct');
        slider.addEventListener('input', () => {
          const v = +slider.value;
          label.textContent = v + '%';
          const d = loadData(yr);
          if (!d[dateKey]) d[dateKey] = {};
          if (v > 0) d[dateKey][cat.id] = v;
          else delete d[dateKey][cat.id];
          if (d[dateKey] && !Object.keys(d[dateKey]).length) delete d[dateKey];
          saveData(yr, d);
        });
      });

      logDialog.showModal();
    }

    // â”€â”€â”€ Settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let tempCats = [];

    function openSettings() {
      tempCats = cfg.categories.map(c => ({ ...c }));
      renderCatList();
      settingsPanel.classList.add('open');
    }
    function closeSettings() { settingsPanel.classList.remove('open'); }

    function renderCatList() {
      const el = document.getElementById('catList');
      el.innerHTML = '';
      tempCats.forEach((cat, i) => {
        const row = document.createElement('div');
        row.className = 'cat-row';
        row.innerHTML =
          `<input type="color" value="${cat.color}" data-i="${i}">` +
          `<input type="text" value="${cat.name}" data-i="${i}" placeholder="Category name">` +
          `<button class="cat-del" data-i="${i}" title="Delete">âœ•</button>`;
        el.appendChild(row);
      });
    }

    // â”€â”€â”€ Tooltip â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function showTooltip(cell, dateKey) {
      const data = loadData(viewYear), dd = data[dateKey], dt = parseDate(dateKey);
      let html = `<b>${MONTH_FULL[dt.getMonth()]} ${dt.getDate()}</b>`;
      if (dd && typeof dd === 'object') {
        const items = cfg.categories.filter(c => dd[c.id] > 0);
        html += items.length
          ? '<br>' + items.map(c => `${c.name}: ${dd[c.id]}%`).join(', ')
          : '<br>No activity';
      } else html += '<br>No activity';
      tooltip.innerHTML = html;
      const r = cell.getBoundingClientRect();
      tooltip.style.left = (r.left + r.width / 2 - tooltip.offsetWidth / 2) + 'px';
      tooltip.style.top  = (r.top - tooltip.offsetHeight - 6) + 'px';
      tooltip.classList.add('visible');
    }
    function hideTooltip() { tooltip.classList.remove('visible'); }

    // â”€â”€â”€ Events â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    root.addEventListener('click', e => {
      // Cell click â†’ open log
      const cell = e.target.closest('[data-date]');
      if (cell && (cell.classList.contains('cell') || cell.classList.contains('month-cell') || cell.classList.contains('week-row'))) {
        openLog(cell.dataset.date);
        return;
      }
      // View toggle
      const vb = e.target.closest('[data-view]');
      if (vb) {
        const m = vb.dataset.view;
        if (m !== viewMode) {
          viewMode = m;
          if (m === 'week' && !viewWeekStart) viewWeekStart = getMondayOfWeek(new Date());
          render();
        }
        return;
      }
      // Navigation
      const act = e.target.closest('[data-act]')?.dataset.act;
      if (act === 'py') { viewYear--; render(); }
      else if (act === 'ny') { viewYear++; render(); }
      else if (act === 'pm') { viewMonth--; if (viewMonth < 0) { viewMonth = 11; viewYear--; } render(); }
      else if (act === 'nm') { viewMonth++; if (viewMonth > 11) { viewMonth = 0; viewYear++; } render(); }
      else if (act === 'pw') { viewWeekStart.setDate(viewWeekStart.getDate() - 7); viewYear = viewWeekStart.getFullYear(); render(); }
      else if (act === 'nw') { viewWeekStart.setDate(viewWeekStart.getDate() + 7); viewYear = viewWeekStart.getFullYear(); render(); }
      // Month label â†’ month view
      const ml = e.target.closest('[data-month]');
      if (ml && ml.classList.contains('hm-month-label')) {
        viewMonth = +ml.dataset.month; viewMode = 'month'; render(); return;
      }
      // Filter chip
      const fc = e.target.closest('[data-cat]');
      if (fc && fc.classList.contains('filter-chip')) {
        const id = fc.dataset.cat;
        activeFilters.has(id) ? activeFilters.delete(id) : activeFilters.add(id);
        render();
      }
    });

    // Hover tooltip
    root.addEventListener('mouseover', e => {
      const c = e.target.closest('.cell:not(.empty), .month-cell:not(.empty)');
      if (c?.dataset.date) showTooltip(c, c.dataset.date);
    });
    root.addEventListener('mouseout', e => {
      if (e.target.closest('.cell, .month-cell')) hideTooltip();
    });

    // Dialog events
    document.getElementById('dlgDone').addEventListener('click', () => { logDialog.close(); render(); });
    logDialog.addEventListener('click', e => { if (e.target === logDialog) { logDialog.close(); render(); } });

    // Settings events
    document.getElementById('gearBtn').addEventListener('click', openSettings);
    document.getElementById('cancelSettingsBtn').addEventListener('click', closeSettings);
    document.getElementById('addCatBtn').addEventListener('click', () => {
      tempCats.push({ id: uid(), name: '', color: '#888888' });
      renderCatList();
    });
    document.getElementById('saveSettingsBtn').addEventListener('click', () => {
      const rows = document.getElementById('catList').querySelectorAll('.cat-row');
      const nc = [];
      rows.forEach((r, i) => {
        const name = r.querySelector('input[type="text"]').value.trim();
        const color = r.querySelector('input[type="color"]').value;
        if (name) nc.push({ id: tempCats[i].id, name, color });
      });
      cfg.categories = nc;
      saveCfg(cfg);
      activeFilters = new Set(cfg.categories.map(c => c.id));
      closeSettings();
      render();
    });
    document.getElementById('catList').addEventListener('click', e => {
      const btn = e.target.closest('.cat-del');
      if (btn) { tempCats.splice(+btn.dataset.i, 1); renderCatList(); }
    });

    // Keyboard â€” Enter on cell
    root.addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        const c = e.target.closest('.cell:not(.empty), .month-cell:not(.empty)');
        if (c?.dataset.date) openLog(c.dataset.date);
      }
    });

    // â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    cfg = loadCfg();
    migrateOldData();
    activeFilters = new Set(cfg.categories.map(c => c.id));
    render();
  })();
  </script>
</body>
</html>
